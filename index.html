<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Casino Lobby</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=DM+Sans:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
<style>
/* ========================================
   RESET & BASE ‚Äî No scroll, full viewport
   ======================================== */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
html, body {
  width: 100%; height: 100%;
  overflow: hidden;
  background: #050510;
  font-family: 'DM Sans', sans-serif;
  color: #f0e6c8;
  cursor: default;
  -webkit-tap-highlight-color: transparent;
  -webkit-user-select: none;
  user-select: none;
}
canvas { display: block; }

/* ========================================
   LOADING SCREEN
   ======================================== */
#loading {
  position: fixed; inset: 0; z-index: 9999;
  background: #050510;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  transition: opacity 0.8s ease;
}
#loading.fade-out { opacity: 0; pointer-events: none; }
#loading h1 {
  font-family: 'Orbitron', sans-serif;
  font-size: 28px; font-weight: 900;
  letter-spacing: 6px;
  background: linear-gradient(135deg, #ffd700, #f0a030, #ffd700);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text; margin-bottom: 30px;
}
.loader-bar {
  width: 200px; height: 3px;
  background: rgba(255,215,0,0.15);
  border-radius: 2px; overflow: hidden;
}
.loader-bar-inner {
  width: 0%; height: 100%;
  background: linear-gradient(90deg, #ffd700, #ff8c00);
  border-radius: 2px;
  animation: loadProgress 1.5s ease-out forwards;
}
@keyframes loadProgress { to { width: 100%; } }

/* ========================================
   HUD ‚Äî Top Bar
   ======================================== */
#hud-top {
  position: fixed; top: 0; left: 0; right: 0;
  z-index: 100;
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 20px;
  background: rgba(5, 5, 16, 0.7);
  backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
  border-bottom: 1px solid rgba(255, 215, 0, 0.1);
  transform: translateY(-100%);
}
#hud-top.visible { transform: translateY(0); }

.hud-logo {
  font-family: 'Orbitron', sans-serif;
  font-size: 15px; font-weight: 900;
  letter-spacing: 4px;
  background: linear-gradient(135deg, #ffd700, #f0a030);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
}

.hud-center { display: flex; align-items: center; gap: 20px; }
.hud-right { display: flex; align-items: center; gap: 12px; }

.balance-pill {
  display: flex; align-items: center; gap: 6px;
  padding: 5px 14px;
  background: rgba(255, 215, 0, 0.08);
  border: 1px solid rgba(255, 215, 0, 0.2);
  border-radius: 50px;
  font-family: 'Orbitron', sans-serif;
  font-size: 13px; font-weight: 700;
  color: #ffd700;
}
.balance-pill .coin {
  width: 18px; height: 18px;
  background: linear-gradient(135deg, #ffd700, #b8860b);
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 9px; color: #1a0a00; font-weight: 900;
}

.jackpot-mini {
  display: flex; align-items: center; gap: 6px;
  padding: 5px 14px;
  background: rgba(255, 45, 120, 0.08);
  border: 1px solid rgba(255, 45, 120, 0.2);
  border-radius: 50px;
  font-family: 'Orbitron', sans-serif;
  font-size: 13px; font-weight: 700;
  color: #ff6b9d;
}
.jackpot-mini .diamond { font-size: 12px; }

.avatar-hud {
  width: 34px; height: 34px;
  border-radius: 50%;
  border: 2px solid #ffd700;
  background: linear-gradient(135deg, #1a1a3e, #0a0a2e);
  display: flex; align-items: center; justify-content: center;
  font-size: 16px;
  cursor: pointer;
  position: relative;
}
.avatar-hud .status-dot {
  position: absolute; bottom: -1px; right: -1px;
  width: 10px; height: 10px;
  background: #00ff88;
  border-radius: 50%;
  border: 2px solid #050510;
}

.mission-btn {
  width: 34px; height: 34px;
  border-radius: 50%;
  border: 1px solid rgba(255, 215, 0, 0.2);
  background: rgba(255, 215, 0, 0.05);
  display: flex; align-items: center; justify-content: center;
  font-size: 14px;
  cursor: pointer;
  position: relative;
}
.mission-btn .badge {
  position: absolute; top: -4px; right: -4px;
  width: 16px; height: 16px;
  background: #ff2d78;
  border-radius: 50%;
  font-size: 9px; font-weight: 700; color: white;
  display: flex; align-items: center; justify-content: center;
}

/* ========================================
   HUD ‚Äî Bottom Navigation
   ======================================== */
#hud-bottom {
  position: fixed; bottom: 0; left: 0; right: 0;
  z-index: 100;
  display: flex; align-items: center; justify-content: center;
  gap: 8px;
  padding: 12px 20px;
  background: rgba(5, 5, 16, 0.7);
  backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
  border-top: 1px solid rgba(255, 215, 0, 0.1);
  transform: translateY(100%);
}
#hud-bottom.visible { transform: translateY(0); }

.nav-btn {
  display: flex; flex-direction: column; align-items: center; gap: 3px;
  padding: 6px 16px;
  border-radius: 12px;
  background: transparent;
  border: 1px solid transparent;
  cursor: pointer;
  transition: all 0.3s ease;
  color: rgba(240, 230, 200, 0.5);
}
.nav-btn:hover, .nav-btn.active {
  background: rgba(255, 215, 0, 0.08);
  border-color: rgba(255, 215, 0, 0.2);
  color: #ffd700;
}
.nav-btn .nav-icon { font-size: 20px; }
.nav-btn .nav-label { font-size: 10px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; }

/* ========================================
   BUILDING LABELS (3D projected)
   ======================================== */
.building-label {
  position: fixed;
  pointer-events: none;
  text-align: center;
  transform: translate(-50%, -50%);
  z-index: 50;
  opacity: 0;
  transition: opacity 0.5s ease;
}
.building-label.visible { opacity: 1; }
.building-label .label-name {
  font-family: 'Orbitron', sans-serif;
  font-size: 14px; font-weight: 700;
  letter-spacing: 3px;
  text-transform: uppercase;
  color: white;
  text-shadow: 0 0 20px currentColor, 0 0 40px currentColor;
}
.building-label .label-sub {
  font-size: 11px;
  color: rgba(240, 230, 200, 0.6);
  margin-top: 4px;
}

/* ========================================
   ZONE PANEL (slide-in on enter)
   ======================================== */
#zone-panel {
  position: fixed;
  top: 60px; right: -420px;
  width: 400px;
  bottom: 70px;
  z-index: 90;
  background: rgba(10, 10, 30, 0.85);
  backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
  border-left: 1px solid rgba(255, 215, 0, 0.12);
  border-radius: 20px 0 0 20px;
  padding: 24px;
  overflow-y: auto;
  transition: right 0.5s cubic-bezier(0.4, 0, 0.2, 1), bottom 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}
#zone-panel.open { right: 0; }
#zone-panel::-webkit-scrollbar { width: 4px; }
#zone-panel::-webkit-scrollbar-thumb { background: rgba(255,215,0,0.2); border-radius: 2px; }

.zone-header {
  display: flex; align-items: center; gap: 12px;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 1px solid rgba(255, 215, 0, 0.1);
}
.zone-header .zone-icon { font-size: 32px; }
.zone-header .zone-title {
  font-family: 'Orbitron', sans-serif;
  font-size: 18px; font-weight: 700;
  letter-spacing: 2px;
}
.zone-header .zone-subtitle {
  font-size: 12px;
  color: rgba(240, 230, 200, 0.5);
  margin-top: 2px;
}

.zone-card {
  background: rgba(255, 255, 255, 0.04);
  border: 1px solid rgba(255, 215, 0, 0.08);
  border-radius: 14px;
  padding: 16px;
  margin-bottom: 12px;
  cursor: pointer;
  transition: all 0.25s ease;
}
.zone-card:hover {
  background: rgba(255, 215, 0, 0.06);
  border-color: rgba(255, 215, 0, 0.2);
  transform: translateX(-4px);
}
.zone-card .card-top {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 8px;
}
.zone-card .card-name {
  font-weight: 700; font-size: 14px;
}
.zone-card .card-badge {
  font-size: 10px; font-weight: 700;
  padding: 2px 8px;
  border-radius: 50px;
  background: rgba(0, 255, 136, 0.1);
  color: #00ff88;
  border: 1px solid rgba(0, 255, 136, 0.2);
}
.zone-card .card-badge.hot {
  background: rgba(255, 45, 120, 0.1);
  color: #ff6b9d;
  border-color: rgba(255, 45, 120, 0.2);
}
.zone-card .card-desc {
  font-size: 12px;
  color: rgba(240, 230, 200, 0.5);
  line-height: 1.5;
}

/* ========================================
   BACK BUTTON
   ======================================== */
#back-btn {
  position: fixed;
  top: 70px; left: 20px;
  z-index: 95;
  display: flex; align-items: center; gap: 8px;
  padding: 8px 18px;
  background: rgba(5, 5, 16, 0.8);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 215, 0, 0.15);
  border-radius: 50px;
  font-family: 'DM Sans', sans-serif;
  font-size: 13px; font-weight: 600;
  color: rgba(240, 230, 200, 0.7);
  cursor: pointer;
  opacity: 0; pointer-events: none;
  transition: all 0.3s ease;
}
#back-btn.visible { opacity: 1; pointer-events: all; }
#back-btn:hover {
  border-color: rgba(255, 215, 0, 0.4);
  color: #ffd700;
}

/* ========================================
   JACKPOT BROADCAST
   ======================================== */
#jackpot-broadcast {
  position: fixed;
  top: 60px; left: 50%;
  transform: translateX(-50%) translateY(-80px);
  z-index: 110;
  padding: 10px 30px;
  background: rgba(255, 215, 0, 0.1);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 215, 0, 0.3);
  border-radius: 50px;
  font-family: 'Orbitron', sans-serif;
  font-size: 13px; font-weight: 700;
  color: #ffd700;
  white-space: nowrap;
  pointer-events: none;
  text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
}

/* ========================================
   RESPONSIVE
   ======================================== */
/* --- Tablet (‚â§768px) --- */
@media (max-width: 768px) {
  #zone-panel { width: calc(100% - 20px); right: -100%; top: 55px; bottom: 65px; border-radius: 16px 0 0 16px; }
  #zone-panel.open { right: 0; }
  .hud-logo { font-size: 12px; letter-spacing: 2px; }
  .balance-pill, .jackpot-mini { font-size: 11px; padding: 4px 10px; }
  .building-label .label-name { font-size: 11px; }
  .nav-btn { padding: 5px 10px; }
  #back-btn { top: 60px; left: 12px; padding: 6px 14px; font-size: 12px; }
  .zone-header .zone-title { font-size: 16px; }
  .zone-card .card-name { font-size: 13px; }
}

/* --- iPhone 14 Pro Max baseline (‚â§480px) --- */
@media (max-width: 480px) {
  /* Top HUD: compact single row */
  #hud-top {
    padding: 6px 12px;
    padding-top: env(safe-area-inset-top, 6px);
  }
  .hud-logo { font-size: 11px; letter-spacing: 1px; }
  .hud-center { gap: 6px; }
  .balance-pill { font-size: 10px; padding: 3px 8px; }
  .balance-pill .coin { width: 14px; height: 14px; font-size: 7px; }
  .jackpot-mini { font-size: 10px; padding: 3px 8px; }
  .jackpot-mini .diamond { font-size: 10px; }
  .avatar-hud { width: 28px; height: 28px; font-size: 13px; }
  .mission-btn { width: 28px; height: 28px; font-size: 12px; }
  .hud-right { gap: 6px; }

  /* Bottom nav: larger touch targets */
  #hud-bottom {
    padding: 8px 8px;
    padding-bottom: max(8px, env(safe-area-inset-bottom, 8px));
    gap: 2px;
  }
  .nav-btn { padding: 6px 10px; min-width: 54px; }
  .nav-btn .nav-icon { font-size: 18px; }
  .nav-btn .nav-label { font-size: 8px; letter-spacing: 0.5px; }

  /* Zone panel: slide up from bottom, half screen */
  #zone-panel {
    top: auto;
    right: 0;
    left: 0;
    bottom: -100%;
    width: 100%;
    height: 55%;
    border-radius: 20px 20px 0 0;
    border-left: none;
    border-top: 1px solid rgba(255, 215, 0, 0.12);
    padding: 20px 16px;
    padding-bottom: max(16px, env(safe-area-inset-bottom, 16px));
    transition: bottom 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }
  #zone-panel.open { right: 0; bottom: 0; }

  .zone-header { margin-bottom: 16px; padding-bottom: 12px; }
  .zone-header .zone-icon { font-size: 26px; }
  .zone-header .zone-title { font-size: 15px; letter-spacing: 1px; }
  .zone-header .zone-subtitle { font-size: 11px; }
  .zone-card { padding: 12px; margin-bottom: 8px; border-radius: 10px; }
  .zone-card .card-name { font-size: 13px; }
  .zone-card .card-desc { font-size: 11px; }

  /* Building labels */
  .building-label .label-name { font-size: 10px; letter-spacing: 2px; }
  .building-label .label-sub { font-size: 9px; }

  /* Back button */
  #back-btn { top: auto; bottom: 58%; left: 50%; transform: translateX(-50%); padding: 6px 18px; font-size: 12px; border-radius: 50px; }
  #back-btn.visible { opacity: 1; pointer-events: all; }

  /* Broadcast */
  #jackpot-broadcast { font-size: 10px; padding: 7px 16px; max-width: 90vw; }
}

/* ========================================
   TRANSITIONS
   ======================================== */
#hud-top, #hud-bottom {
  transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}
</style>
</head>
<body>

<!-- Loading Screen -->
<div id="loading">
  <h1>CASINO</h1>
  <div class="loader-bar"><div class="loader-bar-inner"></div></div>
</div>

<!-- HUD Top -->
<div id="hud-top">
  <div class="hud-logo">CASINO</div>
  <div class="hud-center">
    <div class="balance-pill">
      <div class="coin">$</div>
      <span id="balance-val">12,580.00</span>
    </div>
    <div class="jackpot-mini">
      <span class="diamond">üíé</span>
      <span id="jackpot-val">$2,847,392</span>
    </div>
  </div>
  <div class="hud-right">
    <div class="mission-btn" id="mission-toggle">üìã<div class="badge">3</div></div>
    <div class="avatar-hud">üé≠<div class="status-dot"></div></div>
  </div>
</div>

<!-- HUD Bottom -->
<div id="hud-bottom">
  <div class="nav-btn active" data-zone="overview"><span class="nav-icon">üè†</span><span class="nav-label">Lobby</span></div>
  <div class="nav-btn" data-zone="slots"><span class="nav-icon">üé∞</span><span class="nav-label">Slots</span></div>
  <div class="nav-btn" data-zone="live"><span class="nav-icon">üé≠</span><span class="nav-label">Live</span></div>
  <div class="nav-btn" data-zone="fishing"><span class="nav-icon">üêü</span><span class="nav-label">Fish</span></div>
  <div class="nav-btn" data-zone="jackpot"><span class="nav-icon">üíé</span><span class="nav-label">Jackpot</span></div>
</div>

<!-- Back Button -->
<div id="back-btn">‚Üê Lobby</div>

<!-- Zone Panel -->
<div id="zone-panel"></div>

<!-- Jackpot Broadcast -->
<div id="jackpot-broadcast"></div>

<!-- Building Labels Container -->
<div id="labels-container"></div>

<!-- Three.js -->
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.162.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.162.0/examples/jsm/"
  }
}
</script>
<script type="module">
import * as THREE from 'three';
import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

// ============================================================
// CONFIG
// ============================================================
const COLORS = {
  slots:   { primary: 0xa855f7, secondary: 0xffd700, ambient: 0x5a2a8a },
  live:    { primary: 0xff2d55, secondary: 0xffd700, ambient: 0x7a2a3a },
  fishing: { primary: 0x00d4ff, secondary: 0x00ff88, ambient: 0x1a5a7a },
  jackpot: { primary: 0xffd700, secondary: 0xffffff, ambient: 0x7a5a1a },
};

const BUILDING_POS = {
  slots:   { x: -18, y: 0, z: -5 },
  live:    { x: 18, y: 0, z: -5 },
  fishing: { x: -16, y: 0, z: -35 },
  jackpot: { x: 0, y: 0, z: -45 },
};

const CAM_STATES = {
  overview: { pos: [0, 18, 32], target: [0, 4, -18] },
  slots:   { pos: [-6, 10, 10], target: [-18, 4, -5] },
  live:    { pos: [6, 10, 10], target: [18, 4, -5] },
  fishing: { pos: [-4, 9, -18], target: [-16, 3, -35] },
  jackpot: { pos: [0, 12, -26], target: [0, 5, -45] },
};

const ZONE_CONTENT = {
  slots: {
    icon: 'üé∞', title: 'SLOT HALL', subtitle: 'Spin to Win',
    cards: [
      { name: 'Wolf Gold', badge: 'HOT', hot: true, desc: 'Wild wolf adventure with mega jackpots' },
      { name: 'Book of Dead', badge: 'NEW', hot: false, desc: 'Ancient Egypt treasure hunt' },
      { name: 'Sweet Bonanza', badge: 'TOP', hot: true, desc: 'Candy cascade with multipliers' },
      { name: 'Starburst', badge: 'CLASSIC', hot: false, desc: 'Cosmic jewels expanding wilds' },
      { name: 'Gates of Olympus', badge: 'HOT', hot: true, desc: 'Zeus thunderbolt multipliers' },
    ]
  },
  live: {
    icon: 'üé≠', title: 'LIVE STAGE', subtitle: 'Real Dealers Await',
    cards: [
      { name: 'Lightning Roulette', badge: 'LIVE', hot: true, desc: '500x lightning multipliers' },
      { name: 'Blackjack VIP', badge: 'VIP', hot: false, desc: 'High stakes private table' },
      { name: 'Baccarat Squeeze', badge: 'LIVE', hot: true, desc: 'Dramatic card reveal experience' },
      { name: 'Crazy Time', badge: 'HOT', hot: true, desc: 'Game show mega wheel' },
    ]
  },
  fishing: {
    icon: 'üêü', title: 'FISHING HARBOR', subtitle: 'Cast Your Fortune',
    cards: [
      { name: 'Ocean King', badge: 'HOT', hot: true, desc: 'Underwater boss battles' },
      { name: 'Golden Toad', badge: 'NEW', hot: false, desc: 'Legendary treasure fishing' },
      { name: 'Dragon Hunter', badge: 'TOP', hot: true, desc: 'Sea dragon epic battles' },
    ]
  },
  jackpot: {
    icon: 'üíé', title: 'JACKPOT TEMPLE', subtitle: 'Fortune Awaits',
    cards: [
      { name: 'Mega Vault', badge: '$4.2M', hot: true, desc: 'Progressive mega jackpot pool' },
      { name: 'Daily Fortune', badge: 'DAILY', hot: false, desc: 'Guaranteed daily winner' },
      { name: 'Golden Wheel', badge: '$890K', hot: true, desc: 'Spin the golden wheel of fortune' },
    ]
  },
};

// ============================================================
// STATE
// ============================================================
let currentZone = 'overview';
let hoveredBuilding = null;
const buildings = {};
const buildingMeshes = [];
const labelElements = {};
const clock = new THREE.Clock();

// ============================================================
// SCENE SETUP
// ============================================================
const W = window.innerWidth, H = window.innerHeight;
const scene = new THREE.Scene();
scene.fog = new THREE.FogExp2(0x0a0a20, 0.008);

const camera = new THREE.PerspectiveCamera((W < H) ? 70 : 55, W / H, 0.1, 500);
camera.position.set(...CAM_STATES.overview.pos);
const camTarget = new THREE.Vector3(...CAM_STATES.overview.target);
camera.lookAt(camTarget);

const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
renderer.setSize(W, H);
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 2.0;
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;
document.body.appendChild(renderer.domElement);

// Post-processing: Bloom
const composer = new EffectComposer(renderer);
composer.addPass(new RenderPass(scene, camera));
const bloomPass = new UnrealBloomPass(
  new THREE.Vector2(W, H), 0.5, 0.5, 0.5
);
composer.addPass(bloomPass);

// ============================================================
// LIGHTING
// ============================================================
const ambientLight = new THREE.AmbientLight(0x334466, 3.0);
scene.add(ambientLight);

// Hemisphere light for natural fill (sky blue + ground warm)
const hemiLight = new THREE.HemisphereLight(0x6688cc, 0x443355, 1.2);
scene.add(hemiLight);

const moonLight = new THREE.DirectionalLight(0x8899cc, 1.5);
moonLight.position.set(10, 30, 20);
moonLight.castShadow = true;
moonLight.shadow.mapSize.set(1024, 1024);
moonLight.shadow.camera.near = 1;
moonLight.shadow.camera.far = 120;
moonLight.shadow.camera.left = -50;
moonLight.shadow.camera.right = 50;
moonLight.shadow.camera.top = 50;
moonLight.shadow.camera.bottom = -60;
scene.add(moonLight);

// ============================================================
// ENVIRONMENT ‚Äî Ground
// ============================================================
const groundGeo = new THREE.CircleGeometry(100, 64);
const groundMat = new THREE.MeshStandardMaterial({
  color: 0x22223a,
  emissive: 0x0e0e22,
  emissiveIntensity: 0.5,
  metalness: 0.6,
  roughness: 0.4,
});
const ground = new THREE.Mesh(groundGeo, groundMat);
ground.rotation.x = -Math.PI / 2;
ground.receiveShadow = true;
scene.add(ground);

// Ground rings (decorative)
for (let i = 1; i <= 4; i++) {
  const ring = new THREE.Mesh(
    new THREE.RingGeometry(i * 15 - 0.05, i * 15 + 0.05, 64),
    new THREE.MeshStandardMaterial({
      color: 0xffd700, emissive: 0xffd700,
      emissiveIntensity: 0.6, toneMapped: false,
      transparent: true, opacity: 0.25,
    })
  );
  ring.rotation.x = -Math.PI / 2;
  ring.position.y = 0.02;
  scene.add(ring);
}

// Center emblem
const emblemGeo = new THREE.RingGeometry(2, 2.8, 6);
const emblemMat = new THREE.MeshStandardMaterial({
  color: 0xffd700, emissive: 0xffd700,
  emissiveIntensity: 1.5, toneMapped: false,
  transparent: true, opacity: 0.5,
});
const emblem = new THREE.Mesh(emblemGeo, emblemMat);
emblem.rotation.x = -Math.PI / 2;
emblem.position.set(0, 0.03, -15);
scene.add(emblem);

// ============================================================
// ENVIRONMENT ‚Äî Glowing Ground Paths (connect buildings)
// ============================================================
const pathMat = new THREE.MeshStandardMaterial({
  color: 0xffd700, emissive: 0xffd700,
  emissiveIntensity: 0.6, toneMapped: false,
  transparent: true, opacity: 0.12,
});

function createPath(from, to) {
  const dx = to.x - from.x, dz = to.z - from.z;
  const len = Math.sqrt(dx * dx + dz * dz);
  const angle = Math.atan2(dx, dz);
  const pathGeo = new THREE.PlaneGeometry(0.4, len);
  const path = new THREE.Mesh(pathGeo, pathMat);
  path.rotation.x = -Math.PI / 2;
  path.rotation.z = -angle;
  path.position.set((from.x + to.x) / 2, 0.04, (from.z + to.z) / 2);
  scene.add(path);
}

// Center hub point
const hub = { x: 0, z: -18 };
createPath(hub, BUILDING_POS.slots);
createPath(hub, BUILDING_POS.live);
createPath(hub, BUILDING_POS.fishing);
createPath(hub, BUILDING_POS.jackpot);

// Ground uplights along paths
const uplightPositions = [
  { x: -6, z: -9 }, { x: -12, z: -7 },   // towards slots
  { x: 6, z: -9 }, { x: 12, z: -7 },       // towards live
  { x: -6, z: -22 }, { x: -10, z: -27 },   // towards fishing
  { x: 0, z: -26 }, { x: 0, z: -35 },       // towards jackpot
];
for (const p of uplightPositions) {
  const uplight = new THREE.PointLight(0xffd700, 2, 12);
  uplight.position.set(p.x, 0.5, p.z);
  scene.add(uplight);
  // Small glowing dot on ground
  const dot = new THREE.Mesh(
    new THREE.CircleGeometry(0.3, 16),
    new THREE.MeshStandardMaterial({
      color: 0xffd700, emissive: 0xffd700,
      emissiveIntensity: 1.5, toneMapped: false,
      transparent: true, opacity: 0.4,
    })
  );
  dot.rotation.x = -Math.PI / 2;
  dot.position.set(p.x, 0.03, p.z);
  scene.add(dot);
}

// ============================================================
// ENVIRONMENT ‚Äî Starfield
// ============================================================
const starCount = 1500;
const starPositions = new Float32Array(starCount * 3);
const starSizes = new Float32Array(starCount);
for (let i = 0; i < starCount; i++) {
  const theta = Math.random() * Math.PI * 2;
  const phi = Math.acos(Math.random() * 0.6 + 0.4);
  const r = 80 + Math.random() * 120;
  starPositions[i * 3] = r * Math.sin(phi) * Math.cos(theta);
  starPositions[i * 3 + 1] = r * Math.cos(phi);
  starPositions[i * 3 + 2] = r * Math.sin(phi) * Math.sin(theta);
  starSizes[i] = Math.random() * 2 + 0.5;
}
const starGeo = new THREE.BufferGeometry();
starGeo.setAttribute('position', new THREE.BufferAttribute(starPositions, 3));
starGeo.setAttribute('size', new THREE.BufferAttribute(starSizes, 1));
const starMat = new THREE.PointsMaterial({
  color: 0xffffff, size: 0.5,
  transparent: true, opacity: 0.8,
  sizeAttenuation: true,
});
scene.add(new THREE.Points(starGeo, starMat));

// ============================================================
// ENVIRONMENT ‚Äî Floating Particles (Gold dust)
// ============================================================
const particleCount = 120;
const particleGeo = new THREE.BufferGeometry();
const particlePos = new Float32Array(particleCount * 3);
const particleVel = [];
for (let i = 0; i < particleCount; i++) {
  particlePos[i * 3] = (Math.random() - 0.5) * 90;
  particlePos[i * 3 + 1] = Math.random() * 25;
  particlePos[i * 3 + 2] = (Math.random() - 0.5) * 100 - 10;
  particleVel.push({
    x: (Math.random() - 0.5) * 0.01,
    y: Math.random() * 0.01 + 0.005,
    z: (Math.random() - 0.5) * 0.01,
  });
}
particleGeo.setAttribute('position', new THREE.BufferAttribute(particlePos, 3));
const particleMat = new THREE.PointsMaterial({
  color: 0xffd700, size: 0.15,
  transparent: true, opacity: 0.6,
  sizeAttenuation: true,
});
const particles = new THREE.Points(particleGeo, particleMat);
scene.add(particles);

function updateParticles() {
  const pos = particles.geometry.attributes.position.array;
  for (let i = 0; i < particleCount; i++) {
    pos[i * 3] += particleVel[i].x;
    pos[i * 3 + 1] += particleVel[i].y;
    pos[i * 3 + 2] += particleVel[i].z;
    if (pos[i * 3 + 1] > 26) {
      pos[i * 3] = (Math.random() - 0.5) * 90;
      pos[i * 3 + 1] = 0;
      pos[i * 3 + 2] = (Math.random() - 0.5) * 100 - 10;
    }
  }
  particles.geometry.attributes.position.needsUpdate = true;
}

// ============================================================
// BUILDING HELPERS
// ============================================================
function makeEmissiveMat(color, intensity = 2.5) {
  return new THREE.MeshStandardMaterial({
    color, emissive: color,
    emissiveIntensity: intensity,
    toneMapped: false,
  });
}

function makeWallMat(color) {
  return new THREE.MeshStandardMaterial({
    color, emissive: color,
    emissiveIntensity: 0.6,
    metalness: 0.3, roughness: 0.5,
  });
}

function addNeonEdge(group, geo, color, pos, rot) {
  const mesh = new THREE.Mesh(geo, makeEmissiveMat(color, 3));
  if (pos) mesh.position.set(pos.x || 0, pos.y || 0, pos.z || 0);
  if (rot) {
    if (rot.x) mesh.rotation.x = rot.x;
    if (rot.y) mesh.rotation.y = rot.y;
    if (rot.z) mesh.rotation.z = rot.z;
  }
  group.add(mesh);
  return mesh;
}

// ============================================================
// BUILDING: SLOT HALL (Purple/Gold Neon Arcade)
// ============================================================
function createSlotHall() {
  const group = new THREE.Group();
  const C = COLORS.slots;

  // Main body
  const body = new THREE.Mesh(
    new THREE.BoxGeometry(9, 7, 6),
    makeWallMat(C.ambient)
  );
  body.position.y = 3.5;
  body.castShadow = true;
  group.add(body);

  // Entrance arch
  const arch = new THREE.Mesh(
    new THREE.TorusGeometry(2.5, 0.12, 8, 32, Math.PI),
    makeEmissiveMat(C.primary, 4)
  );
  arch.position.set(0, 0.3, 3.05);
  group.add(arch);

  // Top decorative bar
  addNeonEdge(group,
    new THREE.BoxGeometry(9.2, 0.15, 0.15),
    C.primary, { y: 7.1, z: 3 }
  );
  addNeonEdge(group,
    new THREE.BoxGeometry(9.2, 0.15, 0.15),
    C.secondary, { y: 7.4, z: 3 }
  );

  // Side neon strips
  for (const x of [-4.55, 4.55]) {
    addNeonEdge(group,
      new THREE.BoxGeometry(0.12, 7, 0.12),
      C.primary, { x, y: 3.5, z: 3 }
    );
  }

  // Roof crown gem
  const gem = new THREE.Mesh(
    new THREE.OctahedronGeometry(0.6),
    makeEmissiveMat(C.secondary, 3)
  );
  gem.position.set(0, 8.2, 0);
  gem.userData.animate = 'rotate';
  group.add(gem);

  // Entrance pillars
  for (const x of [-3, 3]) {
    const pillar = new THREE.Mesh(
      new THREE.CylinderGeometry(0.25, 0.3, 5.5, 8),
      new THREE.MeshStandardMaterial({ color: 0x4a2a7a, metalness: 0.7, roughness: 0.3, emissive: 0x2a1a5a, emissiveIntensity: 0.2 })
    );
    pillar.position.set(x, 2.75, 3.05);
    pillar.castShadow = true;
    group.add(pillar);
  }

  // Slot symbols (3 small cylinders representing reels)
  for (let i = -1; i <= 1; i++) {
    const reel = new THREE.Mesh(
      new THREE.CylinderGeometry(0.3, 0.3, 0.1, 16),
      makeEmissiveMat(i === 0 ? C.secondary : C.primary, 2)
    );
    reel.rotation.x = Math.PI / 2;
    reel.position.set(i * 1.2, 5.5, 3.06);
    group.add(reel);
  }

  // Point lights
  const light1 = new THREE.PointLight(C.primary, 8, 25);
  light1.position.set(0, 4, 6);
  group.add(light1);

  const light2 = new THREE.PointLight(C.secondary, 4, 15);
  light2.position.set(0, 8.5, 0);
  group.add(light2);

  // Ground glow disc
  const glowDisc = new THREE.Mesh(
    new THREE.CircleGeometry(10, 32),
    new THREE.MeshStandardMaterial({
      color: C.primary, emissive: C.primary,
      emissiveIntensity: 1.0, toneMapped: false,
      transparent: true, opacity: 0.3,
    })
  );
  glowDisc.rotation.x = -Math.PI / 2;
  glowDisc.position.y = 0.02;
  group.add(glowDisc);

  const bp = BUILDING_POS.slots;
  group.position.set(bp.x, bp.y, bp.z);
  group.userData = { id: 'slots', labelY: 9.5 };
  return group;
}

// ============================================================
// BUILDING: LIVE STAGE (Red/Gold Spotlight Theater)
// ============================================================
function createLiveStage() {
  const group = new THREE.Group();
  const C = COLORS.live;

  // Main stage platform
  const platform = new THREE.Mesh(
    new THREE.CylinderGeometry(5, 5.5, 1.2, 32),
    new THREE.MeshStandardMaterial({ color: 0x4a1a2a, metalness: 0.6, roughness: 0.3, emissive: 0x3a0a1a, emissiveIntensity: 0.25 })
  );
  platform.position.y = 0.6;
  platform.castShadow = true;
  platform.receiveShadow = true;
  group.add(platform);

  // Stage rim light
  const rim = new THREE.Mesh(
    new THREE.TorusGeometry(5.1, 0.08, 8, 64),
    makeEmissiveMat(C.primary, 3)
  );
  rim.rotation.x = -Math.PI / 2;
  rim.position.y = 1.22;
  group.add(rim);

  // Backdrop curve
  const backdropGeo = new THREE.CylinderGeometry(5.5, 5.5, 8, 32, 1, true, Math.PI * 0.7, Math.PI * 1.6);
  const backdrop = new THREE.Mesh(
    backdropGeo,
    new THREE.MeshStandardMaterial({
      color: 0x5a2a35, emissive: 0x3a1a25, emissiveIntensity: 0.2,
      metalness: 0.3, roughness: 0.7,
      side: THREE.DoubleSide,
    })
  );
  backdrop.position.y = 5.2;
  group.add(backdrop);

  // Backdrop top neon trim
  const trimRing = new THREE.Mesh(
    new THREE.TorusGeometry(5.55, 0.1, 8, 64, Math.PI * 1.6),
    makeEmissiveMat(C.primary, 3)
  );
  trimRing.rotation.x = -Math.PI / 2;
  trimRing.rotation.z = Math.PI * 0.7;
  trimRing.position.y = 9.2;
  group.add(trimRing);

  // Dealer table (center)
  const table = new THREE.Mesh(
    new THREE.CylinderGeometry(1.5, 1.5, 0.15, 32, 1, false, 0, Math.PI),
    new THREE.MeshStandardMaterial({ color: 0x1a7a4a, metalness: 0.2, roughness: 0.8, emissive: 0x0a3a1a, emissiveIntensity: 0.2 })
  );
  table.position.set(0, 1.35, 0.5);
  group.add(table);

  // Spotlight cone (visual)
  const spotGeo = new THREE.ConeGeometry(3, 10, 32, 1, true);
  const spotMat = new THREE.MeshStandardMaterial({
    color: C.secondary, emissive: C.secondary,
    emissiveIntensity: 0.3, toneMapped: false,
    transparent: true, opacity: 0.06,
    side: THREE.DoubleSide,
  });
  const spotCone = new THREE.Mesh(spotGeo, spotMat);
  spotCone.position.set(0, 7, 0);
  group.add(spotCone);

  // Spot light (actual)
  const spotLight = new THREE.SpotLight(C.secondary, 12, 25, Math.PI / 6, 0.5, 1);
  spotLight.position.set(0, 14, 0);
  spotLight.target.position.set(0, 0, 0);
  group.add(spotLight);
  group.add(spotLight.target);

  // Point lights
  const light1 = new THREE.PointLight(C.primary, 6, 22);
  light1.position.set(0, 3, 5);
  group.add(light1);

  // Ground glow
  const glowDisc = new THREE.Mesh(
    new THREE.CircleGeometry(10, 32),
    new THREE.MeshStandardMaterial({
      color: C.primary, emissive: C.primary,
      emissiveIntensity: 0.8, toneMapped: false,
      transparent: true, opacity: 0.3,
    })
  );
  glowDisc.rotation.x = -Math.PI / 2;
  glowDisc.position.y = 0.02;
  group.add(glowDisc);

  const bp = BUILDING_POS.live;
  group.position.set(bp.x, bp.y, bp.z);
  group.userData = { id: 'live', labelY: 10.5 };
  return group;
}

// ============================================================
// BUILDING: FISHING HARBOR (Cyan/Blue Waterfront)
// ============================================================
function createFishingHarbor() {
  const group = new THREE.Group();
  const C = COLORS.fishing;

  // Pier deck
  const pier = new THREE.Mesh(
    new THREE.BoxGeometry(8, 0.4, 12),
    new THREE.MeshStandardMaterial({ color: 0x6a4a2a, roughness: 0.9, emissive: 0x3a2a1a, emissiveIntensity: 0.15 })
  );
  pier.position.set(0, 1.5, 0);
  pier.castShadow = true;
  group.add(pier);

  // Pier supports
  for (const x of [-3.5, 0, 3.5]) {
    for (const z of [-4, 0, 4]) {
      const support = new THREE.Mesh(
        new THREE.CylinderGeometry(0.15, 0.2, 1.8, 6),
        new THREE.MeshStandardMaterial({ color: 0x5a3a1a, roughness: 0.9 })
      );
      support.position.set(x, 0.6, z);
      group.add(support);
    }
  }

  // Lighthouse tower
  const tower = new THREE.Mesh(
    new THREE.CylinderGeometry(0.8, 1.2, 7, 8),
    new THREE.MeshStandardMaterial({ color: 0x3a5a7a, metalness: 0.3, roughness: 0.6, emissive: 0x1a3a5a, emissiveIntensity: 0.2 })
  );
  tower.position.set(-2.5, 5.2, -4);
  tower.castShadow = true;
  group.add(tower);

  // Lighthouse top (lantern)
  const lantern = new THREE.Mesh(
    new THREE.CylinderGeometry(1, 0.8, 1.5, 8),
    makeEmissiveMat(C.primary, 2)
  );
  lantern.position.set(-2.5, 9.2, -4);
  group.add(lantern);

  // Lighthouse roof
  const roof = new THREE.Mesh(
    new THREE.ConeGeometry(1.1, 1.5, 8),
    new THREE.MeshStandardMaterial({ color: 0x4a6a8a })
  );
  roof.position.set(-2.5, 10.5, -4);
  group.add(roof);

  // Water plane
  const water = new THREE.Mesh(
    new THREE.PlaneGeometry(16, 18),
    new THREE.MeshStandardMaterial({
      color: 0x0066aa, emissive: 0x003366,
      emissiveIntensity: 0.5,
      transparent: true, opacity: 0.6,
      metalness: 0.9, roughness: 0.1,
    })
  );
  water.rotation.x = -Math.PI / 2;
  water.position.set(0, -0.1, 0);
  group.add(water);

  // Boat
  const boatHull = new THREE.Mesh(
    new THREE.BoxGeometry(1.5, 0.6, 3),
    new THREE.MeshStandardMaterial({ color: 0x7a4a2a, emissive: 0x3a2a1a, emissiveIntensity: 0.15 })
  );
  boatHull.position.set(3, 0.5, 3);
  boatHull.rotation.y = 0.3;
  group.add(boatHull);

  // Neon railing
  for (const x of [-4, 4]) {
    const rail = new THREE.Mesh(
      new THREE.BoxGeometry(0.08, 0.8, 12),
      makeEmissiveMat(C.primary, 1.5)
    );
    rail.position.set(x, 2.1, 0);
    group.add(rail);
  }

  // Lights
  const cyanLight = new THREE.PointLight(C.primary, 8, 28);
  cyanLight.position.set(-2.5, 10, -4);
  group.add(cyanLight);

  const greenLight = new THREE.PointLight(C.secondary, 4, 18);
  greenLight.position.set(0, 3, 0);
  group.add(greenLight);

  // Ground glow
  const glowDisc = new THREE.Mesh(
    new THREE.CircleGeometry(12, 32),
    new THREE.MeshStandardMaterial({
      color: C.primary, emissive: C.primary,
      emissiveIntensity: 0.8, toneMapped: false,
      transparent: true, opacity: 0.25,
    })
  );
  glowDisc.rotation.x = -Math.PI / 2;
  glowDisc.position.y = 0.01;
  group.add(glowDisc);

  const bp = BUILDING_POS.fishing;
  group.position.set(bp.x, bp.y, bp.z);
  group.userData = { id: 'fishing', labelY: 12 };
  return group;
}

// ============================================================
// BUILDING: JACKPOT TEMPLE (Gold/White Grand Temple)
// ============================================================
function createJackpotTemple() {
  const group = new THREE.Group();
  const C = COLORS.jackpot;

  // Steps
  for (let i = 0; i < 4; i++) {
    const step = new THREE.Mesh(
      new THREE.BoxGeometry(14 - i * 2, 0.5, 8 - i * 0.8),
      new THREE.MeshStandardMaterial({
        color: 0x4a4a1a, metalness: 0.6, roughness: 0.3,
        emissive: 0x2a2a0a, emissiveIntensity: 0.2,
      })
    );
    step.position.y = i * 0.5 + 0.25;
    step.castShadow = true;
    step.receiveShadow = true;
    group.add(step);
  }

  // Main temple floor
  const floor = new THREE.Mesh(
    new THREE.BoxGeometry(10, 0.3, 6),
    new THREE.MeshStandardMaterial({ color: 0x5a5a2a, metalness: 0.7, roughness: 0.3, emissive: 0x2a2a0a, emissiveIntensity: 0.15 })
  );
  floor.position.y = 2.15;
  group.add(floor);

  // Columns
  const colPositions = [[-4, -2], [-4, 2], [4, -2], [4, 2], [-1.5, -2], [-1.5, 2], [1.5, -2], [1.5, 2]];
  for (const [x, z] of colPositions) {
    const col = new THREE.Mesh(
      new THREE.CylinderGeometry(0.3, 0.35, 6, 12),
      new THREE.MeshStandardMaterial({ color: 0xd4b030, metalness: 0.7, roughness: 0.3, emissive: 0x806010, emissiveIntensity: 0.2 })
    );
    col.position.set(x, 5.3, z);
    col.castShadow = true;
    group.add(col);

    // Column cap
    const cap = new THREE.Mesh(
      new THREE.BoxGeometry(0.8, 0.3, 0.8),
      new THREE.MeshStandardMaterial({ color: 0xe8c050, metalness: 0.8, roughness: 0.2, emissive: 0x806010, emissiveIntensity: 0.15 })
    );
    cap.position.set(x, 8.4, z);
    group.add(cap);
  }

  // Roof beam
  const beam = new THREE.Mesh(
    new THREE.BoxGeometry(10.5, 0.6, 5.5),
    new THREE.MeshStandardMaterial({ color: 0x5a4a20, metalness: 0.5, roughness: 0.4, emissive: 0x2a2010, emissiveIntensity: 0.15 })
  );
  beam.position.y = 8.8;
  group.add(beam);

  // Triangular pediment
  const pedimentGeo = new THREE.BufferGeometry();
  const pedimentVerts = new Float32Array([
    -5.25, 9.1, 2.8,   5.25, 9.1, 2.8,   0, 12, 2.8,
    -5.25, 9.1, -2.8,  5.25, 9.1, -2.8,   0, 12, -2.8,
  ]);
  const pedimentIdx = [0, 1, 2, 3, 5, 4];
  pedimentGeo.setAttribute('position', new THREE.BufferAttribute(pedimentVerts, 3));
  pedimentGeo.setIndex(pedimentIdx);
  pedimentGeo.computeVertexNormals();
  const pediment = new THREE.Mesh(
    pedimentGeo,
    new THREE.MeshStandardMaterial({ color: 0x5a4a20, metalness: 0.5, roughness: 0.5, emissive: 0x2a2010, emissiveIntensity: 0.15, side: THREE.DoubleSide })
  );
  group.add(pediment);

  // Floating mega diamond
  const diamond = new THREE.Mesh(
    new THREE.OctahedronGeometry(1.2),
    makeEmissiveMat(C.primary, 4)
  );
  diamond.position.set(0, 13.5, 0);
  diamond.userData.animate = 'floatRotate';
  group.add(diamond);

  // Diamond glow sphere
  const diamondGlow = new THREE.Mesh(
    new THREE.SphereGeometry(2, 16, 16),
    new THREE.MeshStandardMaterial({
      color: C.primary, emissive: C.primary,
      emissiveIntensity: 0.5, toneMapped: false,
      transparent: true, opacity: 0.08,
    })
  );
  diamondGlow.position.set(0, 13.5, 0);
  group.add(diamondGlow);

  // Neon edge on pediment
  addNeonEdge(group,
    new THREE.BoxGeometry(10.5, 0.1, 0.1),
    C.primary, { y: 9.15, z: 2.85 }
  );

  // Lights
  const goldLight1 = new THREE.PointLight(C.primary, 10, 30);
  goldLight1.position.set(0, 14, 0);
  group.add(goldLight1);

  const goldLight2 = new THREE.PointLight(C.primary, 5, 20);
  goldLight2.position.set(0, 5, 5);
  group.add(goldLight2);

  const whiteLight = new THREE.PointLight(C.secondary, 4, 18);
  whiteLight.position.set(0, 10, 0);
  group.add(whiteLight);

  // Ground glow
  const glowDisc = new THREE.Mesh(
    new THREE.CircleGeometry(12, 32),
    new THREE.MeshStandardMaterial({
      color: C.primary, emissive: C.primary,
      emissiveIntensity: 1.0, toneMapped: false,
      transparent: true, opacity: 0.3,
    })
  );
  glowDisc.rotation.x = -Math.PI / 2;
  glowDisc.position.y = 0.02;
  group.add(glowDisc);

  const bp = BUILDING_POS.jackpot;
  group.position.set(bp.x, bp.y, bp.z);
  group.userData = { id: 'jackpot', labelY: 16 };
  return group;
}

// ============================================================
// CREATE ALL BUILDINGS
// ============================================================
function initBuildings() {
  const factories = {
    slots: createSlotHall,
    live: createLiveStage,
    fishing: createFishingHarbor,
    jackpot: createJackpotTemple,
  };
  for (const [id, factory] of Object.entries(factories)) {
    const building = factory();
    buildings[id] = building;
    scene.add(building);
    // Collect all meshes for raycasting
    building.traverse((child) => {
      if (child.isMesh) {
        child.userData.buildingId = id;
        buildingMeshes.push(child);
      }
    });
    // Create label
    createLabel(id, building);
  }
}

// ============================================================
// BUILDING LABELS (HTML positioned via 3D projection)
// ============================================================
const labelsContainer = document.getElementById('labels-container');

function createLabel(id, building) {
  const info = {
    slots: { name: 'SLOT HALL', sub: '14,392 Playing', color: '#a855f7' },
    live: { name: 'LIVE STAGE', sub: '5,218 At Tables', color: '#ff2d55' },
    fishing: { name: 'FISHING HARBOR', sub: '3,847 Fishing', color: '#00d4ff' },
    jackpot: { name: 'JACKPOT TEMPLE', sub: '$4.2M Prize Pool', color: '#ffd700' },
  };
  const data = info[id];
  const el = document.createElement('div');
  el.className = 'building-label';
  el.innerHTML = `
    <div class="label-name" style="color:${data.color}">${data.name}</div>
    <div class="label-sub">${data.sub}</div>
  `;
  labelsContainer.appendChild(el);
  labelElements[id] = { el, building };
}

function updateLabels() {
  if (currentZone !== 'overview') {
    Object.values(labelElements).forEach(({ el }) => el.classList.remove('visible'));
    return;
  }
  for (const [id, { el, building }] of Object.entries(labelElements)) {
    const labelY = building.userData.labelY || 8;
    const pos3D = new THREE.Vector3(
      building.position.x,
      labelY,
      building.position.z
    );
    pos3D.project(camera);
    const x = (pos3D.x * 0.5 + 0.5) * window.innerWidth;
    const y = (-pos3D.y * 0.5 + 0.5) * window.innerHeight;
    el.style.left = x + 'px';
    el.style.top = y + 'px';
    el.classList.toggle('visible', pos3D.z < 1);
  }
}

// ============================================================
// INTERACTION ‚Äî Raycaster
// ============================================================
const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();
let mouseNDC = new THREE.Vector2();

renderer.domElement.addEventListener('mousemove', (e) => {
  mouseNDC.x = (e.clientX / window.innerWidth) * 2 - 1;
  mouseNDC.y = -(e.clientY / window.innerHeight) * 2 + 1;
});

renderer.domElement.addEventListener('click', (e) => {
  if (currentZone !== 'overview') return;
  mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
  mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
  raycaster.setFromCamera(mouse, camera);
  const hits = raycaster.intersectObjects(buildingMeshes);
  if (hits.length > 0) {
    const id = hits[0].object.userData.buildingId;
    if (id) enterZone(id);
  }
});

// Touch support
renderer.domElement.addEventListener('touchend', (e) => {
  if (currentZone !== 'overview') return;
  const touch = e.changedTouches[0];
  mouse.x = (touch.clientX / window.innerWidth) * 2 - 1;
  mouse.y = -(touch.clientY / window.innerHeight) * 2 + 1;
  raycaster.setFromCamera(mouse, camera);
  const hits = raycaster.intersectObjects(buildingMeshes);
  if (hits.length > 0) {
    const id = hits[0].object.userData.buildingId;
    if (id) enterZone(id);
  }
});

// Hover check
function updateHover() {
  if (currentZone !== 'overview') {
    document.body.style.cursor = 'default';
    return;
  }
  raycaster.setFromCamera(mouseNDC, camera);
  const hits = raycaster.intersectObjects(buildingMeshes);
  const newHover = hits.length > 0 ? hits[0].object.userData.buildingId : null;

  if (newHover !== hoveredBuilding) {
    // Unhover previous
    if (hoveredBuilding && buildings[hoveredBuilding]) {
      gsap.to(buildings[hoveredBuilding].scale, { x: 1, y: 1, z: 1, duration: 0.3 });
    }
    // Hover new
    if (newHover && buildings[newHover]) {
      gsap.to(buildings[newHover].scale, { x: 1.05, y: 1.05, z: 1.05, duration: 0.3 });
    }
    hoveredBuilding = newHover;
    document.body.style.cursor = newHover ? 'pointer' : 'default';
  }
}

// ============================================================
// CAMERA TRANSITIONS
// ============================================================
const camPosObj = { x: CAM_STATES.overview.pos[0], y: CAM_STATES.overview.pos[1], z: CAM_STATES.overview.pos[2] };
const camTargetObj = { x: CAM_STATES.overview.target[0], y: CAM_STATES.overview.target[1], z: CAM_STATES.overview.target[2] };

function transitionCamera(zone) {
  const state = CAM_STATES[zone];
  gsap.to(camPosObj, {
    x: state.pos[0], y: state.pos[1], z: state.pos[2],
    duration: 1.6, ease: 'power2.inOut',
  });
  gsap.to(camTargetObj, {
    x: state.target[0], y: state.target[1], z: state.target[2],
    duration: 1.6, ease: 'power2.inOut',
  });
}

// ============================================================
// ZONE PANEL
// ============================================================
const zonePanel = document.getElementById('zone-panel');
const backBtn = document.getElementById('back-btn');
const navBtns = document.querySelectorAll('.nav-btn');

function enterZone(zone) {
  if (zone === currentZone) return;
  currentZone = zone;
  transitionCamera(zone);

  // Update nav
  navBtns.forEach(btn => {
    btn.classList.toggle('active', btn.dataset.zone === zone);
  });

  // Show zone panel
  const content = ZONE_CONTENT[zone];
  if (content) {
    zonePanel.innerHTML = `
      <div class="zone-header">
        <div class="zone-icon">${content.icon}</div>
        <div>
          <div class="zone-title">${content.title}</div>
          <div class="zone-subtitle">${content.subtitle}</div>
        </div>
      </div>
      ${content.cards.map(c => `
        <div class="zone-card">
          <div class="card-top">
            <div class="card-name">${c.name}</div>
            <div class="card-badge ${c.hot ? 'hot' : ''}">${c.badge}</div>
          </div>
          <div class="card-desc">${c.desc}</div>
        </div>
      `).join('')}
    `;
    setTimeout(() => zonePanel.classList.add('open'), 100);
  }

  // Show back button
  setTimeout(() => backBtn.classList.add('visible'), 300);
}

function exitZone() {
  currentZone = 'overview';
  transitionCamera('overview');
  zonePanel.classList.remove('open');
  backBtn.classList.remove('visible');
  navBtns.forEach(btn => {
    btn.classList.toggle('active', btn.dataset.zone === 'overview');
  });
}

backBtn.addEventListener('click', exitZone);

// Nav button clicks
navBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    const zone = btn.dataset.zone;
    if (zone === 'overview') exitZone();
    else enterZone(zone);
  });
});

// ============================================================
// HUD ‚Äî Jackpot Counter
// ============================================================
let jackpotVal = 2847392;
function updateJackpot() {
  jackpotVal += Math.floor(Math.random() * 30) + 5;
  document.getElementById('jackpot-val').textContent =
    '$' + jackpotVal.toLocaleString();
}
setInterval(updateJackpot, 1800);

// ============================================================
// HUD ‚Äî Balance Animation
// ============================================================
let balanceVal = 12580.00;
function updateBalance() {
  balanceVal += (Math.random() - 0.45) * 2;
  document.getElementById('balance-val').textContent =
    balanceVal.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}
setInterval(updateBalance, 3000);

// ============================================================
// JACKPOT BROADCAST
// ============================================================
const broadcastEl = document.getElementById('jackpot-broadcast');
const broadcastMessages = [
  'üéâ Player_X92 won $12,847 on Wolf Gold!',
  'üíé MEGA JACKPOT hit! $847,291 by LuckyStar!',
  'üî• Player_K17 won $5,432 on Lightning Roulette!',
  'üé∞ BIG WIN! $23,100 on Gates of Olympus!',
  'üí∞ Player_M55 hit Major Jackpot: $156,800!',
];
let broadcastIdx = 0;
function showBroadcast() {
  broadcastEl.textContent = broadcastMessages[broadcastIdx % broadcastMessages.length];
  broadcastIdx++;
  gsap.fromTo(broadcastEl,
    { y: -80, opacity: 0 },
    { y: 0, opacity: 1, duration: 0.5, ease: 'back.out(1.5)',
      onComplete: () => {
        gsap.to(broadcastEl, { y: -80, opacity: 0, duration: 0.4, delay: 3 });
      }
    }
  );
}
setInterval(showBroadcast, 8000);
setTimeout(showBroadcast, 3000);

// ============================================================
// ANIMATED ELEMENTS
// ============================================================
function updateAnimatedElements(time) {
  for (const building of Object.values(buildings)) {
    building.traverse((child) => {
      if (child.userData.animate === 'rotate') {
        child.rotation.y += 0.01;
      }
      if (child.userData.animate === 'floatRotate') {
        child.rotation.y += 0.008;
        child.rotation.x = Math.sin(time * 0.5) * 0.15;
        child.position.y = 13.5 + Math.sin(time * 0.8) * 0.5;
      }
    });
  }
  // Water wobble for fishing
  if (buildings.fishing) {
    buildings.fishing.traverse((child) => {
      if (child.isMesh && child.material.opacity === 0.6 && child.geometry.type === 'PlaneGeometry') {
        child.position.y = -0.1 + Math.sin(time * 1.2) * 0.08;
      }
    });
  }
  // Emblem rotation
  emblem.rotation.z += 0.002;
}

// ============================================================
// RESIZE HANDLER
// ============================================================
window.addEventListener('resize', () => {
  const w = window.innerWidth, h = window.innerHeight;
  camera.aspect = w / h;
  // Widen FOV on portrait screens so buildings stay visible
  camera.fov = (w < h) ? 70 : 55;
  camera.updateProjectionMatrix();
  renderer.setSize(w, h);
  composer.setSize(w, h);
});

// ============================================================
// ANIMATION LOOP
// ============================================================
function animate() {
  requestAnimationFrame(animate);
  const time = clock.getElapsedTime();

  // Update camera
  camera.position.set(camPosObj.x, camPosObj.y, camPosObj.z);
  camTarget.set(camTargetObj.x, camTargetObj.y, camTargetObj.z);
  camera.lookAt(camTarget);

  // Update systems
  updateParticles();
  updateAnimatedElements(time);
  updateLabels();
  updateHover();

  // Subtle breathing light on buildings
  for (const building of Object.values(buildings)) {
    building.traverse((child) => {
      if (child.isPointLight) {
        child.intensity = child.intensity * 0.99 +
          (child.intensity + Math.sin(time * 2 + child.position.x) * 0.3) * 0.01;
      }
    });
  }

  composer.render();
}

// ============================================================
// INIT
// ============================================================
initBuildings();

// Remove loading screen
setTimeout(() => {
  document.getElementById('loading').classList.add('fade-out');
  setTimeout(() => {
    document.getElementById('loading').remove();
    // Show HUD
    document.getElementById('hud-top').classList.add('visible');
    document.getElementById('hud-bottom').classList.add('visible');
  }, 800);
}, 1800);

animate();
</script>
</body>
</html>
